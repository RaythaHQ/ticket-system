@page "/admin/tickets/task-templates/edit/{id}"
@using App.Web.Areas.Admin.Pages.Shared
@model App.Web.Areas.Admin.Pages.TaskTemplates.Edit

@{
    Layout = "SidebarLayout";
    ViewData["Title"] = "Edit Task Template";
    ViewData["ActiveMenu"] = "TaskTemplates";
    ViewData["ExpandTasksMenu"] = true;
}

<div>
    <partial name="_Partials/PageHeading" model='"Edit Task Template"' />

    <form method="post" id="template-form">
        <div class="card mb-4">
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Name <span class="text-danger">*</span></label>
                    <input asp-for="Name" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea asp-for="Description" class="form-control" rows="2"></textarea>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Task Items</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="add-item-btn">
                    <i class="bi bi-plus-circle me-1"></i>Add Task
                </button>
            </div>
            <div class="card-body" id="items-container">
                <div id="items-list"></div>
                <div id="empty-state" class="text-center py-4 text-muted" style="display: none;">
                    <i class="bi bi-list-task fs-3"></i>
                    <p class="mt-2">No task items. Click "Add Task" to add items.</p>
                </div>
            </div>
        </div>

        <input type="hidden" asp-for="ItemsJson" id="items-json" />

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle me-1"></i>Save Changes
            </button>
            <a asp-page="@RouteNames.TaskTemplates.Index" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Pre-populate from existing template data
            const existingItems = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                Model.Template?.Items?.Select((item, index) => new {
                    title = item.Title,
                    dependsOnIndex = Model.Template.Items
                        .Select((x, i) => new { x.Id, Index = i })
                        .FirstOrDefault(x => item.DependsOnItemId.HasValue && x.Id == item.DependsOnItemId)?.Index
                }) ?? Enumerable.Empty<object>()
            ));

            let items = existingItems.map(i => ({
                title: i.title,
                dependsOnIndex: i.dependsOnIndex !== null && i.dependsOnIndex !== undefined ? i.dependsOnIndex : null
            }));

            const container = document.getElementById('items-list');
            const emptyState = document.getElementById('empty-state');
            const addBtn = document.getElementById('add-item-btn');
            const form = document.getElementById('template-form');
            const itemsJsonInput = document.getElementById('items-json');

            function render() {
                container.innerHTML = '';
                emptyState.style.display = items.length === 0 ? 'block' : 'none';

                items.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'border rounded p-3 mb-2 bg-white d-flex align-items-center gap-3';
                    div.dataset.index = index;

                    div.innerHTML = `
                        <i class="bi bi-grip-vertical text-muted drag-handle" style="cursor: grab;"></i>
                        <span class="badge bg-secondary">${index + 1}</span>
                        <input type="text" class="form-control item-title" value="${escapeHtml(item.title)}" placeholder="Task title" required />
                        <select class="form-select dep-select" style="max-width: 200px;">
                            <option value="-1">No dependency</option>
                            ${items.map((other, i) => i !== index ? `<option value="${i}" ${item.dependsOnIndex === i ? 'selected' : ''}>Depends on: ${escapeHtml(other.title || 'Item ' + (i + 1))}</option>` : '').join('')}
                        </select>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-btn"><i class="bi bi-trash"></i></button>
                    `;

                    div.querySelector('.item-title').addEventListener('input', function () {
                        items[index].title = this.value;
                    });

                    div.querySelector('.dep-select').addEventListener('change', function () {
                        const val = parseInt(this.value);
                        items[index].dependsOnIndex = val >= 0 ? val : null;
                    });

                    div.querySelector('.remove-btn').addEventListener('click', function () {
                        items.splice(index, 1);
                        items.forEach(item => {
                            if (item.dependsOnIndex !== null && item.dependsOnIndex !== undefined) {
                                if (item.dependsOnIndex === index) {
                                    item.dependsOnIndex = null;
                                } else if (item.dependsOnIndex > index) {
                                    item.dependsOnIndex--;
                                }
                            }
                        });
                        render();
                    });

                    container.appendChild(div);
                });
            }

            addBtn.addEventListener('click', function () {
                items.push({ title: '', dependsOnIndex: null });
                render();
                const inputs = container.querySelectorAll('.item-title');
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            });

            new Sortable(container, {
                handle: '.drag-handle',
                animation: 200,
                onEnd: function (evt) {
                    const moved = items.splice(evt.oldIndex, 1)[0];
                    items.splice(evt.newIndex, 0, moved);
                    render();
                }
            });

            form.addEventListener('submit', function () {
                itemsJsonInput.value = JSON.stringify(items.map(i => ({
                    title: i.title,
                    dependsOnIndex: i.dependsOnIndex
                })));
            });

            function escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            render();
        });
    </script>
}
