@page "/admin/tickets/task-templates"
@using App.Web.Areas.Admin.Pages.Shared
@model App.Web.Areas.Admin.Pages.TaskTemplates.Index

@{
    Layout = "SidebarLayout";
    ViewData["Title"] = "Task Templates";
    ViewData["ActiveMenu"] = "TaskTemplates";
    ViewData["ExpandTasksMenu"] = true;
}

@Html.AntiForgeryToken()

<div>
    <partial name="_Partials/PageHeading" model='"Task Templates"' />

    <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="text-muted mb-0">Define reusable task templates that staff can apply to tickets.</p>
        <a asp-page="@RouteNames.TaskTemplates.Create" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> New Template
        </a>
    </div>

    @if (!Model.Templates.Any())
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-list-task fs-1 text-muted"></i>
                <p class="text-muted mt-2">No task templates yet. Create one to get started.</p>
                <a asp-page="@RouteNames.TaskTemplates.Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Create Template
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th class="text-center">Tasks</th>
                            <th class="text-center">Active</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var template in Model.Templates)
                        {
                            <tr id="template-@template.Id">
                                <td>
                                    <a asp-page="@RouteNames.TaskTemplates.Edit" asp-route-id="@template.Id" class="fw-semibold text-decoration-none">
                                        @template.Name
                                    </a>
                                </td>
                                <td class="text-muted">@(template.Description ?? "â€”")</td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">@template.ItemCount</span>
                                </td>
                                <td class="text-center">
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input toggle-active"
                                               type="checkbox"
                                               data-id="@template.Id"
                                               @(template.IsActive ? "checked" : "") />
                                    </div>
                                </td>
                                <td class="text-end">
                                    <a asp-page="@RouteNames.TaskTemplates.Edit" asp-route-id="@template.Id"
                                       class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger delete-template"
                                            data-id="@template.Id"
                                            data-name="@template.Name">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Toggle active
            document.querySelectorAll('.toggle-active').forEach(function (toggle) {
                toggle.addEventListener('change', function () {
                    const id = this.dataset.id;
                    const isActive = this.checked;
                    fetch('?handler=ToggleActive', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify({ id, isActive })
                    }).then(r => {
                        if (!r.ok) { this.checked = !isActive; }
                    });
                });
            });

            // Delete
            document.querySelectorAll('.delete-template').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    const id = this.dataset.id;
                    const name = this.dataset.name;
                    if (!confirm(`Delete template "${name}"? This cannot be undone.`)) return;
                    fetch('?handler=Delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify({ id })
                    }).then(r => {
                        if (r.ok) {
                            document.getElementById('template-' + id)?.remove();
                        }
                    });
                });
            });
        });
    </script>
}
