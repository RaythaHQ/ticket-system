@using System.Text.Json
@using App.Web.Areas.Staff.Pages.Shared.Models
@model ColumnSelectorViewModel

@{
    Layout = null;
    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
    var columnsJson = JsonSerializer.Serialize(Model.AvailableColumns, jsonOptions);
    var selectedFields = Model.SelectedColumns ?? new List<string>();
}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Visible Columns</h5>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Select columns to display. Drag to reorder. Search only matches visible columns.
        </p>
        
        <div data-column-selector data-columns="@columnsJson" id="adminColumnSelectorContainer">
            <div id="adminColumnsList">
                @{
                    var hiddenIndex = 0;
                    // First render selected columns in order
                    foreach (var field in selectedFields)
                    {
                        var col = Model.AvailableColumns.FirstOrDefault(c => c.Field.Equals(field, StringComparison.OrdinalIgnoreCase));
                        if (col != null)
                        {
                            <div class="column-item d-flex align-items-center gap-2 mb-2 p-2 border rounded" data-field="@col.Field">
                                <span class="drag-handle text-muted" style="cursor: grab;">
                                    <i class="bi bi-grip-vertical"></i>
                                </span>
                                <input type="checkbox" 
                                       class="form-check-input column-checkbox" 
                                       id="admincol_@col.Field" 
                                       data-field="@col.Field"
                                       checked>
                                <input type="hidden" name="VisibleColumns[@hiddenIndex]" value="@col.Field" class="column-hidden-input">
                                <label class="form-check-label flex-grow-1 mb-0" for="admincol_@col.Field">
                                    @col.Label
                                </label>
                            </div>
                            hiddenIndex++;
                        }
                    }
                    
                    // Then render unselected columns
                    foreach (var col in Model.AvailableColumns)
                    {
                        if (selectedFields.Any(s => s.Equals(col.Field, StringComparison.OrdinalIgnoreCase)))
                            continue;
                        
                        <div class="column-item d-flex align-items-center gap-2 mb-2 p-2 border rounded bg-light" data-field="@col.Field">
                            <span class="drag-handle text-muted" style="cursor: grab;">
                                <i class="bi bi-grip-vertical"></i>
                            </span>
                            <input type="checkbox" 
                                   class="form-check-input column-checkbox" 
                                   id="admincol_@col.Field"
                                   data-field="@col.Field">
                            <label class="form-check-label flex-grow-1 mb-0 text-muted" for="admincol_@col.Field">
                                @col.Label
                            </label>
                        </div>
                    }
                }
            </div>
            
            <div class="text-muted small mt-2">
                <i class="bi bi-info-circle me-1"></i>
                At least one column must be selected.
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('adminColumnsList');
    if (!container) return;
    
    // Initialize SortableJS
    if (typeof Sortable !== 'undefined') {
        new Sortable(container, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: updateColumnInputs
        });
    }
    
    // Handle checkbox changes
    container.addEventListener('change', function(e) {
        if (e.target.classList.contains('column-checkbox')) {
            handleCheckboxChange(e.target);
        }
    });
    
    function handleCheckboxChange(checkbox) {
        const item = checkbox.closest('.column-item');
        const field = checkbox.dataset.field;
        
        if (checkbox.checked) {
            // Add hidden input if not present
            if (!item.querySelector('.column-hidden-input')) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'VisibleColumns[0]'; // Will be reindexed
                input.value = field;
                input.className = 'column-hidden-input';
                checkbox.parentNode.insertBefore(input, checkbox.nextSibling);
            }
            item.classList.remove('bg-light');
            const label = item.querySelector('label');
            if (label) label.classList.remove('text-muted');
        } else {
            // Remove hidden input
            const hiddenInput = item.querySelector('.column-hidden-input');
            if (hiddenInput) hiddenInput.remove();
            item.classList.add('bg-light');
            const label = item.querySelector('label');
            if (label) label.classList.add('text-muted');
        }
        
        updateColumnInputs();
    }
    
    function updateColumnInputs() {
        let idx = 0;
        container.querySelectorAll('.column-item').forEach(item => {
            const hiddenInput = item.querySelector('.column-hidden-input');
            if (hiddenInput) {
                hiddenInput.name = `VisibleColumns[${idx}]`;
                idx++;
            }
        });
    }
});
</script>
