@page "/staff/dashboard"
@model App.Web.Areas.Staff.Pages.Dashboard.Index
@using App.Web.Areas.Staff.Pages.Shared

@{
    ViewData["Title"] = "Dashboard";
    ViewData["ActiveMenu"] = "Dashboard";
}

<div class="staff-page-heading mb-4">
    <h1 class="h3 mb-0">Welcome back!</h1>
    <a asp-page="@RouteNames.Tickets.Create" class="btn btn-primary">
        <i class="bi bi-plus-lg me-2"></i>New Ticket
    </a>
</div>

<!-- Quick Lookup -->
<div class="row g-4 mb-4">
    <!-- Tickets Section -->
    <div class="col-lg-6">
        <div class="staff-card">
            <div class="staff-card-header">
                <h5><i class="bi bi-ticket-detailed me-2"></i>Tickets</h5>
            </div>
            <div class="staff-card-body">
                <!-- Fast Open by ID -->
                <form method="post" asp-page-handler="QuickLookupTicketId" class="mb-3">
                    <label asp-for="QuickLookupTicketId.TicketId" class="form-label small">Ticket ID</label>
                    <input asp-for="QuickLookupTicketId.TicketId" type="number" class="form-control"
                        placeholder="Ticket ID" />
                    <span asp-validation-for="QuickLookupTicketId.TicketId" class="text-danger small"></span>
                    <button type="submit" class="btn btn-primary mt-2 w-100">Go</button>
                </form>

                <hr class="my-4" />

                <!-- Search Tickets -->
                <form method="post" asp-page-handler="QuickSearchTickets">
                    <div class="mb-3">
                        <label asp-for="QuickSearchTickets.ContactId" class="form-label small">Contact ID</label>
                        <input asp-for="QuickSearchTickets.ContactId" type="number" class="form-control form-control-sm"
                            placeholder="Contact ID" />
                    </div>
                    <div class="mb-3">
                        <label asp-for="QuickSearchTickets.ContactPhone" class="form-label small">Contact Phone</label>
                        <input asp-for="QuickSearchTickets.ContactPhone" type="text"
                            class="form-control form-control-sm" placeholder="Phone number" />
                    </div>
                    <div class="mb-3">
                        <label asp-for="QuickSearchTickets.TicketTitle" class="form-label small">Ticket Title</label>
                        <input asp-for="QuickSearchTickets.TicketTitle" type="text" class="form-control form-control-sm"
                            placeholder="Title contains..." />
                    </div>
                    <div class="mb-3">
                        <label asp-for="QuickSearchTickets.AssigneeId" class="form-label small">Assignee</label>
                        <select asp-for="QuickSearchTickets.AssigneeId" class="form-select form-select-sm">
                            <option value="">-- Any --</option>
                            @foreach (var assignee in Model.AvailableAssignees)
                            {
                                <option value="@assignee.AssigneeId">@assignee.DisplayText</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label asp-for="QuickSearchTickets.CreatedById" class="form-label small">Created By</label>
                        <select asp-for="QuickSearchTickets.CreatedById" class="form-select form-select-sm">
                            <option value="">-- Any --</option>
                            @foreach (var user in Model.AvailableCreatedByUsers)
                            {
                                <option value="@user.AssigneeId">@user.DisplayText</option>
                            }
                        </select>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary w-100">Search Tickets</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Contacts Section -->
    <div class="col-lg-6">
        <div class="staff-card">
            <div class="staff-card-header">
                <h5><i class="bi bi-person-vcard me-2"></i>Contacts</h5>
            </div>
            <div class="staff-card-body">
                <!-- Fast Open by ID -->
                <form method="post" asp-page-handler="QuickLookupContactId" class="mb-3">
                    <label asp-for="QuickLookupContactId.ContactId" class="form-label small">Contact ID</label>
                    <input asp-for="QuickLookupContactId.ContactId" type="number" class="form-control"
                        placeholder="Contact ID" />
                    <span asp-validation-for="QuickLookupContactId.ContactId" class="text-danger small"></span>
                    <button type="submit" class="btn btn-primary mt-2 w-100">Go</button>
                </form>

                <hr class="my-4" />

                <!-- Search Contacts -->
                <form method="post" asp-page-handler="QuickSearchContacts">
                    <div class="mb-3">
                        <label asp-for="QuickSearchContacts.FirstName" class="form-label small">First Name</label>
                        <input asp-for="QuickSearchContacts.FirstName" type="text" class="form-control form-control-sm"
                            placeholder="First name contains..." />
                    </div>
                    <div class="mb-3">
                        <label asp-for="QuickSearchContacts.LastName" class="form-label small">Last Name</label>
                        <input asp-for="QuickSearchContacts.LastName" type="text" class="form-control form-control-sm"
                            placeholder="Last name contains..." />
                    </div>
                    <div class="mb-3">
                        <label asp-for="QuickSearchContacts.Phone" class="form-label small">Phone</label>
                        <input asp-for="QuickSearchContacts.Phone" type="text" class="form-control form-control-sm"
                            placeholder="Phone number" />
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary w-100">Search Contacts</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="staff-stat-card primary">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="staff-stat-icon primary">
                    <i class="bi bi-ticket-detailed"></i>
                </div>
            </div>
            <div class="staff-stat-value">@Model.Metrics.OpenTicketsAssigned</div>
            <div class="staff-stat-label">Open Tickets</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="staff-stat-card success">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="staff-stat-icon success">
                    <i class="bi bi-check-circle"></i>
                </div>
            </div>
            <div class="staff-stat-value">@Model.Metrics.TicketsClosedLast7Days</div>
            <div class="staff-stat-label">Closed (7 days)</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="staff-stat-card warning">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="staff-stat-icon warning">
                    <i class="bi bi-calendar-check"></i>
                </div>
            </div>
            <div class="staff-stat-value">@Model.Metrics.TicketsClosedLast30Days</div>
            <div class="staff-stat-label">Closed (30 days)</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="staff-stat-card secondary">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="staff-stat-icon secondary">
                    <i class="bi bi-clock-history"></i>
                </div>
            </div>
            <div class="staff-stat-value">
                @if (Model.Metrics.MedianCloseTimeHours.HasValue)
                {
                    @($"{Model.Metrics.MedianCloseTimeHours.Value:F1}h")
                }
                else
                {
                    <span>â€”</span>
                }
            </div>
            <div class="staff-stat-label">Median Close Time</div>
        </div>
    </div>
</div>

<!-- SLA & Quality Metrics -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="staff-card">
            <div class="staff-card-header">
                <h5><i class="bi bi-hourglass-split me-2"></i>SLA Status</h5>
            </div>
            <div class="staff-card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="p-3">
                            <h3 class="mb-1 @(Model.Metrics.SlaBreachCount > 0 ? "text-danger" : "text-success")"
                                style="font-size: 2.5rem; font-weight: 700;">
                                @Model.Metrics.SlaBreachCount
                            </h3>
                            <p class="text-muted mb-0 small fw-medium">Breached</p>
                        </div>
                    </div>
                    <div class="col-6 border-start">
                        <div class="p-3">
                            <h3 class="mb-1 @(Model.Metrics.SlaApproachingCount > 0 ? "text-warning" : "text-success")"
                                style="font-size: 2.5rem; font-weight: 700;">
                                @Model.Metrics.SlaApproachingCount
                            </h3>
                            <p class="text-muted mb-0 small fw-medium">Approaching Breach</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="staff-card">
            <div class="staff-card-header">
                <h5><i class="bi bi-graph-up me-2"></i>Quality Metrics</h5>
            </div>
            <div class="staff-card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="p-3">
                            <h3 class="mb-1" style="font-size: 2.5rem; font-weight: 700;">@Model.Metrics.ReopenCount
                            </h3>
                            <p class="text-muted mb-0 small fw-medium">Reopened Tickets</p>
                        </div>
                    </div>
                    <div class="col-6 border-start">
                        <div class="p-3">
                            <h3 class="mb-1" style="font-size: 2.5rem; font-weight: 700;">
                                @($"{Model.Metrics.ReopenRate:F1}%")</h3>
                            <p class="text-muted mb-0 small fw-medium">Reopen Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Summaries -->
@if (Model.Metrics.TeamSummaries.Any())
{
    <div class="staff-card mb-4">
        <div class="staff-card-header">
            <h5><i class="bi bi-people me-2"></i>My Teams</h5>
        </div>
        <div class="table-responsive">
            <table class="table staff-table mb-0">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th class="text-center">Open Tickets</th>
                        <th class="text-center">Unassigned</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var team in Model.Metrics.TeamSummaries)
                    {
                        <tr>
                            <td>
                                <span class="fw-semibold">@team.TeamName</span>
                            </td>
                            <td class="text-center">
                                <span class="staff-badge staff-badge-primary">@team.OpenTickets</span>
                            </td>
                            <td class="text-center">
                                <span
                                    class="staff-badge @(team.UnassignedTickets > 0 ? "staff-badge-warning" : "staff-badge-secondary")">
                                    @team.UnassignedTickets
                                </span>
                            </td>
                            <td class="text-end">
                                <a asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="all"
                                    asp-route-teamId="@team.TeamId" class="btn btn-sm btn-outline-primary">
                                    View Tickets
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<!-- Leaderboards -->
<div class="row g-4 mb-4">
    <!-- Staff Leaderboard -->
    <div class="col-lg-6">
        <div class="staff-card">
            <div class="staff-card-header">
                <h5><i class="bi bi-trophy me-2"></i>Staff Leaderboard</h5>
                <span class="text-muted small">Tickets Closed</span>
            </div>
            <div class="table-responsive">
                <table class="table staff-table mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Staff Member</th>
                            <th class="text-center">Today</th>
                            <th class="text-center">This Week</th>
                            <th class="text-center">This Month</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Leaderboard.StaffLeaderboard.Any())
                        {
                            var rank = 0;
                            @foreach (var staff in Model.Leaderboard.StaffLeaderboard)
                            {
                                rank++;
                                var rankBadgeClass = rank switch
                                {
                                    1 => "leaderboard-rank-gold",
                                    2 => "leaderboard-rank-silver",
                                    3 => "leaderboard-rank-bronze",
                                    _ => ""
                                };
                                <tr>
                                    <td class="text-center">
                                        @if (rank <= 3)
                                        {
                                            <span class="leaderboard-rank @rankBadgeClass">@rank</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">@rank</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="fw-semibold">@staff.StaffName</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="@(staff.ClosedToday > 0 ? "fw-bold text-success" : "text-muted")">
                                            @staff.ClosedToday
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="@(staff.ClosedThisWeek > 0 ? "fw-semibold" : "text-muted")">
                                            @staff.ClosedThisWeek
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="staff-badge staff-badge-primary">@staff.ClosedThisMonth</span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox me-2"></i>No tickets closed this month yet
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Team Leaderboard -->
    <div class="col-lg-6">
        <div class="staff-card">
            <div class="staff-card-header">
                <h5><i class="bi bi-people-fill me-2"></i>Team Leaderboard</h5>
                <span class="text-muted small">Tickets Closed</span>
            </div>
            <div class="table-responsive">
                <table class="table staff-table mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Team</th>
                            <th class="text-center">Today</th>
                            <th class="text-center">This Week</th>
                            <th class="text-center">This Month</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Leaderboard.TeamLeaderboard.Any())
                        {
                            var rank = 0;
                            @foreach (var team in Model.Leaderboard.TeamLeaderboard)
                            {
                                rank++;
                                var rankBadgeClass = rank switch
                                {
                                    1 => "leaderboard-rank-gold",
                                    2 => "leaderboard-rank-silver",
                                    3 => "leaderboard-rank-bronze",
                                    _ => ""
                                };
                                <tr>
                                    <td class="text-center">
                                        @if (rank <= 3)
                                        {
                                            <span class="leaderboard-rank @rankBadgeClass">@rank</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">@rank</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="fw-semibold">@team.TeamName</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="@(team.ClosedToday > 0 ? "fw-bold text-success" : "text-muted")">
                                            @team.ClosedToday
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="@(team.ClosedThisWeek > 0 ? "fw-semibold" : "text-muted")">
                                            @team.ClosedThisWeek
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="staff-badge staff-badge-primary">@team.ClosedThisMonth</span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox me-2"></i>No tickets closed this month yet
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .leaderboard-rank {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .leaderboard-rank-gold {
        background: linear-gradient(135deg, #ffd700, #ffb800);
        color: #5a4a00;
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }

    .leaderboard-rank-silver {
        background: linear-gradient(135deg, #e0e0e0, #c0c0c0);
        color: #4a4a4a;
        box-shadow: 0 2px 8px rgba(192, 192, 192, 0.4);
    }

    .leaderboard-rank-bronze {
        background: linear-gradient(135deg, #cd7f32, #b87333);
        color: #fff;
        box-shadow: 0 2px 8px rgba(205, 127, 50, 0.4);
    }

    .staff-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>
