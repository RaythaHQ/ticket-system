@page "/staff/wiki/edit/{id}"
@model App.Web.Areas.Staff.Pages.Wiki.Edit
@using App.Web.Areas.Staff.Pages.Shared

@{
    ViewData["Title"] = "Edit Article";
    ViewData["ActiveMenu"] = "Wiki";
}

<div class="staff-page-heading mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item">
                    <a asp-page="@RouteNames.Wiki.Index" class="text-decoration-none">Wiki</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Edit Article</li>
            </ol>
        </nav>
        <h1 class="h3 mb-0">Edit Article</h1>
    </div>
</div>

<form method="post" id="article-form">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Form.Id" />

    <div class="row">
        <div class="col-lg-9">
            <div class="staff-card mb-4">
                <div class="staff-card-body">
                    <div class="mb-3">
                        <label asp-for="Form.Title" class="form-label fw-semibold">
                            Title <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Form.Title" class="form-control form-control-lg" placeholder="Enter article title..." />
                        <span asp-validation-for="Form.Title" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Form.Content" class="form-label fw-semibold">
                            Content <span class="text-danger">*</span>
                        </label>
                        <input type="hidden" asp-for="Form.Content" id="content-input" />
                        
                        <!-- Quill Editor Container -->
                        <div id="editor" style="min-height: 400px;"></div>
                        <span asp-validation-for="Form.Content" class="text-danger small"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <div class="staff-card mb-4">
                <div class="staff-card-header">
                    <h6 class="mb-0">Settings</h6>
                </div>
                <div class="staff-card-body">
                    <div class="mb-3">
                        <label asp-for="Form.Category" class="form-label fw-semibold">Category</label>
                        <input asp-for="Form.Category" class="form-control" list="category-list" placeholder="Enter or select category..." />
                        <datalist id="category-list">
                            @foreach (var category in Model.ExistingCategories)
                            {
                                <option value="@category"></option>
                            }
                        </datalist>
                        <span asp-validation-for="Form.Category" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Form.Excerpt" class="form-label fw-semibold">
                            Excerpt
                            <small class="text-muted fw-normal">(optional)</small>
                        </label>
                        <textarea asp-for="Form.Excerpt" class="form-control" rows="3" 
                            placeholder="Brief summary for article lists..."></textarea>
                        <span asp-validation-for="Form.Excerpt" class="text-danger small"></span>
                    </div>

                    <div class="form-check mb-2">
                        <input asp-for="Form.IsPublished" class="form-check-input" />
                        <label asp-for="Form.IsPublished" class="form-check-label">
                            <strong>Published</strong>
                            <br /><small class="text-muted">Visible to all staff members</small>
                        </label>
                    </div>

                    <div class="form-check">
                        <input asp-for="Form.IsPinned" class="form-check-input" />
                        <label asp-for="Form.IsPinned" class="form-check-label">
                            <strong>Pinned</strong>
                            <br /><small class="text-muted">Shows at top of article list</small>
                        </label>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg me-1"></i>Save Changes
                </button>
                <a asp-page="@RouteNames.Wiki.Article" asp-route-slug="@Model.Article?.Slug" class="btn btn-outline-secondary">
                    View Article
                </a>
                <a asp-page="@RouteNames.Wiki.Index" class="btn btn-outline-secondary">
                    Cancel
                </a>
            </div>
        </div>
    </div>
</form>

<div class="row">
    <div class="col-lg-9"></div>
    <div class="col-lg-3">
        <hr class="my-4" />

        <div class="staff-card border-danger">
            <div class="staff-card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-1"></i>Danger Zone</h6>
            </div>
            <div class="staff-card-body">
                <p class="small text-muted mb-2">Permanently delete this article. This cannot be undone.</p>
                <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Form.Id">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-danger btn-sm w-100"
                        onclick="return confirm('Are you sure you want to delete this article? This cannot be undone.')">
                        <i class="bi bi-trash me-1"></i>Delete Article
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const contentInput = document.getElementById('content-input');
            const editorContainer = document.getElementById('editor');
            
            // Initialize Quill editor
            const quill = new Quill(editorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        [{ 'align': [] }],
                        ['clean']
                    ]
                },
                placeholder: 'Start writing your article...'
            });

            // Set initial content if exists
            if (contentInput.value) {
                quill.root.innerHTML = contentInput.value;
            }

            // Sync content to hidden input on change
            quill.on('text-change', function() {
                contentInput.value = quill.root.innerHTML;
            });

            // Ensure content is synced before form submission
            document.getElementById('article-form').addEventListener('submit', function() {
                contentInput.value = quill.root.innerHTML;
            });
        });
    </script>
}

<style>
    .ql-container {
        font-size: 1rem;
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    .ql-toolbar {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
        background: #f8f9fa;
    }
    .ql-editor {
        min-height: 380px;
    }
</style>
