@inject App.Application.TicketViews.IFavoriteViewsService FavoriteViewsService
@inject App.Application.Common.Interfaces.IInAppNotificationService NotificationService
@inject App.Application.Common.Interfaces.ISidebarBadgeService SidebarBadgeService
@inject App.Application.Common.Interfaces.ICurrentUser CurrentUser
@{
    Layout = "_StaffBaseLayout";
}

@RenderBody()

@section Sidebar {
    <div class="staff-nav-section">
        <div class="staff-nav-section-title">Main</div>
        <a asp-area="Staff" asp-page="@RouteNames.Dashboard.Index"
            class="staff-nav-link @(ViewData["ActiveMenu"]?.ToString() == "Dashboard" ? "active" : "")">
            <i class="bi bi-grid-1x2"></i>
            <span>Dashboard</span>
        </a>
        @{
            var unreadCount = 0;
            if (CurrentUser.UserId.HasValue)
            {
                unreadCount = await NotificationService.GetUnreadCountAsync(CurrentUser.UserId.Value.Guid);
            }
            var badgeDisplay = unreadCount >= 100 ? "99+" : unreadCount.ToString();
        }
        <a asp-area="Staff" asp-page="@RouteNames.Notifications.Index"
            class="staff-nav-link @(ViewData["ActiveMenu"]?.ToString() == "Notifications" ? "active" : "")">
            <i class="bi bi-bell"></i>
            <span>My Notifications</span>
            <span class="notification-badge" id="notification-badge" style="@(unreadCount > 0 ? "" : "display: none;")">@badgeDisplay</span>
        </a>
        <a asp-area="Staff" asp-page="@RouteNames.Wiki.Index"
            class="staff-nav-link @(ViewData["ActiveMenu"]?.ToString() == "Wiki" ? "active" : "")">
            <i class="bi bi-journal-text"></i>
            <span>Wiki</span>
        </a>
        @{
            var isTasksSection = ViewData["ActiveMenu"]?.ToString() == "Tasks";
            var isTicketsActive = ViewData["ActiveMenu"]?.ToString() == "Tickets";
            // Tickets expanded by default, unless Tasks is the active section
            var ticketsExpanded = !isTasksSection;

            var myTicketCount = 0;
            var myTaskCount = 0;
            if (CurrentUser.UserId.HasValue)
            {
                myTicketCount = await SidebarBadgeService.GetMyTicketCountAsync(CurrentUser.UserId.Value.Guid);
                myTaskCount = await SidebarBadgeService.GetMyTaskCountAsync(CurrentUser.UserId.Value.Guid);
            }
            var ticketBadgeDisplay = myTicketCount >= 100 ? "99+" : myTicketCount.ToString();
            var taskBadgeDisplay = myTaskCount >= 100 ? "99+" : myTaskCount.ToString();
        }
        <div class="staff-nav-item">
            <span
                class="staff-nav-link has-submenu @(ticketsExpanded ? "expanded" : "") @(isTicketsActive ? "active" : "")"
                onclick="toggleSubmenu(event, 'tickets-submenu')">
                <i class="bi bi-ticket-detailed"></i>
                <span>Tickets</span>
                @if (myTicketCount > 0)
                {
                    <span class="nav-count-badge parent-badge">@ticketBadgeDisplay</span>
                }
                <i class="bi bi-chevron-right submenu-arrow"></i>
            </span>
            <div class="staff-submenu @(ticketsExpanded ? "expanded" : "")" id="tickets-submenu">
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="unassigned"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "Unassigned" ? "active" : "")">
                    Unassigned
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="my-tickets"
                    class="staff-submenu-link has-count-badge @(ViewData["ActiveSubMenu"]?.ToString() == "MyTickets" ? "active" : "")">
                    My Tickets
                    @if (myTicketCount > 0)
                    {
                        <span class="nav-count-badge submenu-badge">@ticketBadgeDisplay</span>
                    }
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="created-by-me"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "CreatedByMe" ? "active" : "")">
                    Created by Me
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="team-tickets"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "TeamTickets" ? "active" : "")">
                    Team Tickets
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="overdue"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "Overdue" ? "active" : "")">
                    Overdue
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="snoozed"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "Snoozed" ? "active" : "")">
                    Snoozed
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="following"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "Following" ? "active" : "")">
                    Following
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-builtInView="all"
                    class="staff-submenu-link @(ViewData["ActiveSubMenu"]?.ToString() == "AllTickets" ? "active" : "")">
                    All Tickets
                </a>
                @{
                    var favoriteViews = (await FavoriteViewsService.GetUserFavoriteViewsAsync()).ToList();
                }
                @if (favoriteViews.Any())
                {
                    <div class="staff-submenu-divider"></div>
                    @foreach (var fav in favoriteViews)
                    {
                        <a asp-area="Staff" asp-page="@RouteNames.Tickets.Index" asp-route-viewId="@fav.ViewId"
                            asp-route-sortBy="view"
                            class="staff-submenu-link @(ViewData["ActiveViewId"]?.ToString() == fav.ViewId.ToString() ? "active" : "")">
                            <i class="bi bi-star-fill me-1" style="color: #ffc107; font-size: 0.7rem;"></i>@fav.Name
                        </a>
                    }
                }
            </div>
        </div>
        <div class="staff-nav-item">
            <span
                class="staff-nav-link has-submenu @(isTasksSection ? "expanded active" : "")"
                onclick="toggleSubmenu(event, 'tasks-submenu')">
                <i class="bi bi-check2-square"></i>
                <span>Tasks</span>
                @if (myTaskCount > 0)
                {
                    <span class="nav-count-badge parent-badge">@taskBadgeDisplay</span>
                }
                <i class="bi bi-chevron-right submenu-arrow"></i>
            </span>
            <div class="staff-submenu @(isTasksSection ? "expanded" : "")" id="tasks-submenu">
                <a asp-area="Staff" asp-page="@RouteNames.Tasks.Index" asp-route-view="my-tasks"
                    class="staff-submenu-link has-count-badge @(ViewData["ActiveTaskView"]?.ToString() == "my-tasks" ? "active" : "")">
                    My Tasks
                    @if (myTaskCount > 0)
                    {
                        <span class="nav-count-badge submenu-badge">@taskBadgeDisplay</span>
                    }
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tasks.Index" asp-route-view="team-tasks"
                    class="staff-submenu-link @(ViewData["ActiveTaskView"]?.ToString() == "team-tasks" ? "active" : "")">
                    Team Tasks
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tasks.Index" asp-route-view="unassigned"
                    class="staff-submenu-link @(ViewData["ActiveTaskView"]?.ToString() == "unassigned" ? "active" : "")">
                    Unassigned
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tasks.Index" asp-route-view="created-by-me"
                    class="staff-submenu-link @(ViewData["ActiveTaskView"]?.ToString() == "created-by-me" ? "active" : "")">
                    Created by Me
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tasks.Index" asp-route-view="overdue"
                    class="staff-submenu-link @(ViewData["ActiveTaskView"]?.ToString() == "overdue" ? "active" : "")">
                    Overdue
                </a>
                <a asp-area="Staff" asp-page="@RouteNames.Tasks.Index" asp-route-view="all"
                    class="staff-submenu-link @(ViewData["ActiveTaskView"]?.ToString() == "all" ? "active" : "")">
                    All Tasks
                </a>
            </div>
        </div>
    </div>

    <div class="staff-nav-section">
        <div class="staff-nav-section-title">Manage</div>
        <a asp-area="Staff" asp-page="@RouteNames.Views.Index"
            class="staff-nav-link @(ViewData["ActiveMenu"]?.ToString() == "Views" ? "active" : "")">
            <i class="bi bi-layout-text-window"></i>
            <span>Views</span>
        </a>
        <a asp-area="Staff" asp-page="@RouteNames.Contacts.Index"
            class="staff-nav-link @(ViewData["ActiveMenu"]?.ToString() == "Contacts" ? "active" : "")">
            <i class="bi bi-people"></i>
            <span>Contacts</span>
        </a>
        <a asp-area="Staff" asp-page="@RouteNames.ActivityLog.Index"
            class="staff-nav-link @(ViewData["ActiveMenu"]?.ToString() == "ActivityLog" ? "active" : "")">
            <i class="bi bi-activity"></i>
            <span>Activity Log</span>
        </a>
    </div>
}

@if (IsSectionDefined("headstyles"))
{
    @section headstyles { @RenderSection("headstyles", required: false) }
}

@if (IsSectionDefined("Scripts"))
{
    @section Scripts { @await RenderSectionAsync("Scripts", required: false) }
}
